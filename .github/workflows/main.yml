name: C++ CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1
    - name: Display the path
      run: echo $PATH
    - name: Setup
      run: |
       
    - name: vcpkg cache
      uses: actions/cache@v1
      id: cache-vcpkg
      with:
        path: vcpkg
        key: vcpkg-${{ hashFiles('**\env.lock') }}-${{ hashFiles('**\vcpkg.lock') }}
        restore-keys: vcpkg-${{ hashFiles('**\env.lock') }}-
    - name: vcpkg install
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      shell: bash
      run: |
        source env.sh
        if cd vcpkg; then
          git fetch
        else
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
        fi
        "$VCPKG_INSTALLATION_ROOT/vcpkg" install catch2 docopt ms-gsl eigen3 boost mpfr tbb cgal
        "$VCPKG_INSTALLATION_ROOT/vcpkg" upgrade --no-dry-run
        rm -rf downloads buildtrees packages
    - name: build
      shell: bash 
      run: |
        mkdir build
        cd build
        export VCPKG_ARG=-DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/vcpkg/scripts/buildsystems/vcpkg.cmake"
        cmake $VCPKG_ARG -G "Ninja" -DCMAKE_BUILD_TYP=Debug ..
        cmake --build .
    - name: Test
      run: ctest
